#!/bin/sh
set -e
#
# This script is meant for quick & easy install via:
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <ip1> <ip2> <ip3>'
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s 10.4.0.5 10.4.0.6 10.4.0.7 ssl'
# or:
#   'wget -qO- https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <ip1> <ip2> <ip3>'
#


echo "starting version 1.93"

clustername="catalystdev"
defaultpassword="ILoveElasticSearch2017"

echo "Please enter name for cluster[default:catalystdev]:"
read -e clustername < /dev/tty 
clustername=${clustername:-catalystdev}

echo "Please type in password to use for ElasticSearch built-in accounts[default:ILoveElasticSearch2017]:"
read -e defaultpassword < /dev/tty
defaultpassword=${defaultpassword:-ILoveElasticSearch2017}

echo "Starting setup..."
u="$(whoami)"
echo "User name: $u"

declare -i freememInBytes=10

freememInBytes=$(free|awk '/^Mem:/{print $2}')

# Remember: no spaces allowed in variable set commands in bash
ip1="$1"
ip2="$2"
ip3="$3"
ssl="$4"
paramsToES=""

externalip=$(curl ipecho.net/plain)

# http://stackoverflow.com/questions/8529181/which-terminal-command-to-get-just-ip-address-and-nothing-else
myip=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
#myip=$(hostname -i)

echo "MyIP:"$myip

# create /opt/install folder
installfolder="/opt/install/"
installscriptfile="updatedocker"
installscript="$installfolder$installscriptfile"

mkdir -p $HOME/bin
if [[ ! -d "$installfolder" ]]; then
  sudo mkdir -p $installfolder

  sudo setfacl -m u:$u:rwx $installfolder
fi

# if no IP passed then use this node's IP for ElasticSearch
if [ -z "$ip1" ]; then
  echo "No IP passed in command line so setting ip1 to $myip"
  ip1="$myip"
  ip2="$myip"
  ip3="$myip"
fi

hosts="$ip1"
hostname="$(hostname -s)"

if [ ! -z "$ip2" ]; then
  hosts="$hosts"",""$ip2"
fi

if [ ! -z "$ip3" ]; then
  hosts="$hosts"",""$ip3"
fi

# ask if user wants to use SSL
if [ ! -z "$ssl" ]; then
  while true; do
      read -e -p "Do you wish to turn on SSL?" yn < /dev/tty
      case $yn in
          [Yy]* ) ssl="yes"; break;;
          [Nn]* ) exit;;
          * ) echo "Please answer yes or no.";;
      esac
  done
fi

if [ ! -z "$ssl" ]; then
  echo "Setting up SSL"

  if [[ ! -f "$installfolder/node.key" ]]; then
    echo "$installfolder/node.key does not exist" 
    exit 1
  fi
  if [[ ! -f "$installfolder/node.crt" ]]; then
    echo "$installfolder/node.crt does not exist" 
    exit 1
  fi
  if [[ ! -f "$installfolder/ca.crt" ]]; then
    echo "$installfolder/ca.crt does not exist" 
    exit 1
  fi    

  paramsToES="-e xpack.security.http.ssl.enabled=true -e xpack.ssl.key=node.key -e xpack.ssl.certificate=node.crt -e xpack.ssl.certificate_authorities=ca.crt -e xpack.security.transport.ssl.enabled=true -e xpack.security.transport.ssl.verification_mode=certificate"

fi

javaOpts="-Xms6g -Xmx6g"
if [ $freememInBytes -lt 8000000 ]; then
  echo "WARNING: Less than 8GB of memory is free so setting ES to run in 2GB but this is not recommended for good performance"
  javaOpts="-Xms2g -Xmx2g"
fi

echo "==== Parameters ======"
echo "node name: [$hostname]" 
echo "ip1: $ip1"
echo "ip2: $ip2"
echo "ip3: $ip3"
echo "myip: $myip"
echo "hosts: $hosts"
echo "freememInBytes: $freememInBytes"
echo "javaOpts: $javaOpts"
echo "==== End Parameters ===="

echo "==== Creating update script ===="


echo "#!/bin/sh" > $installscript
echo "curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s $@" >> $installscript
chmod +x $installscript

if [[ ! -e "$HOME/bin/$installscriptfile" ]]; then 
  echo "creating a symbolic link for install file"
  echo "ln -f -s $installscript $HOME/bin/$installscriptfile"
  ln -f -s $installscript $HOME/bin/$installscriptfile
fi

echo "==== Update script ===="
cat $installscript
echo "==== End Update Script ===="

echo "==== Downloading and installing ElasticSearch Docker container ===="

echo "====  existing containers on this host ===="
docker ps -a

echo "==== existing images on this host ===="
docker images

echo "==== existing volumes on this host ===="
docker volume ls

volumeParam="-v esdata1:/usr/share/elasticsearch/data1 -v esdata2:/usr/share/elasticsearch/data2"

if [[ ! -d "/mnt/data1" ]]; then
  echo "/mnt/data1 does not exist so creating docker volumes"
  # check to see if volume already exists.  if not, create it
  if [ -z $(docker volume ls -q --filter "name=esdata1") ]; then
    echo "==== Creating persistent volume for ElasticSearch ===="
    docker volume create --name esdata1
  fi
  if [ -z $(docker volume ls -q --filter "name=esdata2") ]; then
    echo "==== Creating persistent volume for ElasticSearch ===="
    docker volume create --name esdata2
  fi
else
  volumeParam="-v /mnt/data1:/usr/share/elasticsearch/data -v /mnt/data2:/usr/share/elasticsearch/data2"
fi

echo "stopping existing docker container"
docker stop dockerelasticsearch || echo 'no container to stop'
echo "removing docker container"
docker rm dockerelasticsearch || echo 'no container to remove'
echo "removing docker image"
docker rmi imranq2/dockerelasticsearch || echo 'no image to remove'
echo "pulling latest docker image from repo"
docker pull imranq2/dockerelasticsearch
echo "starting docker container with new image"
set -x
# https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html

docker run -d -p 9200:9200 -p 9300:9300 $volumeParam --cap-add=IPC_LOCK --ulimit memlock=-1:-1 --ulimit nofile=262144:262144 --add-host es-master:$ip1 --add-host es-slave1:$ip2 --add-host es-slave2:$ip3 --security-opt seccomp=unconfined -e ES_JAVA_OPTS="$javaOpts" -e network.host=_eth0_ -e network.publish_host=$myip -e node.name=$hostname -e discovery.zen.ping.unicast.hosts="$hosts" -e cluster.name=$clustername -e xpack.security.enabled=true -e bootstrap.memory_lock=true $paramsToES --name dockerelasticsearch imranq2/dockerelasticsearch
set +x

echo "sleeping until docker container is up"
until [ "`/usr/bin/docker inspect -f {{.State.Running}} dockerelasticsearch`"=="true" ]; do
    sleep 1s;
done;

nodekeyfile="node.key"
nodekeypath="$installfolder$nodekeyfile"

protocol="http"

if [ ! -z "$ssl" ]; then
  echo "Checking if [$nodekeypath] exists"
  if [[ -f "$nodekeypath" ]]; then
    echo "copying ssl keys from $installfolder"
    docker cp $installfolder/node.key dockerelasticsearch:/usr/share/elasticsearch/config
    docker cp $installfolder/node.crt dockerelasticsearch:/usr/share/elasticsearch/config
    docker cp $installfolder/ca.crt dockerelasticsearch:/usr/share/elasticsearch/config

    protocol="https"
  else
    echo "ERROR: No key files found in [$nodekeypath] so cannot set up SSL"
  fi

  docker restart dockerelasticsearch
  echo "sleeping until docker container is up"
  until [ "`/usr/bin/docker inspect -f {{.State.Running}} dockerelasticsearch`"=="true" ]; do
      sleep 1s;
  done;

fi

echo "==== Listing running docker containers ===="
docker ps

echo "sleeping for 30 secs"
sleep 30s;

echo "==== calling ElasticSearch from localhost ===="

declare -i c=10

c=0

# disable set -e so the script does not break when there is an error with curl
set +e

while [ $c -lt 60 ]; do
    echo "curl -X GET $protocol://localhost:9200"
    curl -X GET -u elastic:changeme $protocol://localhost:9200 -k
    RETVAL=$?
    echo "RETVAL:[$RETVAL]"
    if [ $RETVAL -eq 0 ]; then 
      break 
    fi    
    c=$c+1
    echo "Trying again [$c]"
    sleep 1s
done

set -e

# https://www.elastic.co/guide/en/x-pack/current/setting-up-authentication.html
echo "Resetting default passwords"
set -x
responseStatus=$(curl -X GET -u elastic:changeme $protocol://localhost:9200 -k | jq -s .[0].status)

if [ "$responseStatus" == "401" ]; then
  echo "default password was already changed"
else
  echo "changing default password"
  curl -XPUT -u elastic:changeme "$protocol://localhost:9200/_xpack/security/user/elastic/_password" -d"{ \"password\": \"$defaultpassword\"}" -k
fi

curl -XPUT -u elastic:$defaultpassword "$protocol://localhost:9200/_xpack/security/user/kibana/_password" -d"{ \"password\": \"$defaultpassword\"}" -k
curl -XPUT -u elastic:$defaultpassword "$protocol://localhost:9200/_xpack/security/user/logstash_system/_password" -d"{ \"password\": \"$defaultpassword\"}" -k

echo "curl -X GET $protocol://localhost:9200/_cluster/health?pretty"
curl -X GET -u elastic:$defaultpassword $protocol://localhost:9200/_cluster/health?pretty -k
set +x

echo "listing all nodes"
curl -XGET -u elastic:$defaultpassword $protocol://localhost:9200/_nodes/_all/host,ip,name?pretty -k

echo "creating a test index"
curl -XPOST -u elastic:$defaultpassword "$protocol://localhost:9200/testindex/testdoc/1" -d'{"name": "foo","age":10}' -k

echo "querying test document"
curl -XPOST -u elastic:$defaultpassword "$protocol://localhost:9200/testindex/_search?pretty" -d'{"query": {"match_all": {}}}' -k

# echo "checking from externalip"
# curl -X GET http://$externalip:9200


externalip=$(curl ipecho.net/plain)
echo "External IP:" $externalip

echo "==== All Done ===="
echo "NOTE To update the docker image on this host in the future, just run"
echo "$installscriptfile"
