#!/bin/sh
set -e

echo "Version 1.01"

#
# This script is meant for quick & easy install via:
#   'curl -sSL https://healthcatalyst.github.io/InstallScripts/nlp/installnlpswarm.txt | sh -s <mysqlserver> <solrserver> <jobserver>'

# Remember: no spaces allowed in variable set commands in bash

authority=$1
authcert=$2

echo "creating nlpnet network"
docker network create --driver overlay nlpnet

echo "creating mysql service"
docker service create --name mysqlserver \
	--env MYSQL_ROOT_PASSWORD=new-password \
	--env MYSQL_DATABASE=nlpmt \
	--env MYSQL_USER=NLP_APP_USER \
	--env MYSQL_PASSWORD=yourpassword \
	--replicas 1 \
	--constraint "node.id == mysql" \	
	--network nlpnet \
    -p 3306:3306 \
    --restart=unless-stopped \
	healthcatalyst/fabric.nlp.docker.mysql

echo "Sleeping..."
sleep 10s;

docker exec mysqlserver bin/bash ./setup_nlp_tables.sh

echo "creating solr service"
docker service create --name solrserver \
	--replicas 1 \
	--network nlpnet \
    -p 8085:8085 \
    --restart=unless-stopped \
	healthcatalyst/fabric.nlp.docker.solr

echo "Sleeping..."
sleep 10s;

docker exec solrserver bin/bash bin/solr create_core -c report_core

echo "creating jobs service"
docker service create --name jobserver \
	--replicas 1 \
	--network nlpnet \
    -p 8084:8084 \
    --restart=unless-stopped \
	healthcatalyst/fabric.nlp.docker.jobs

echo "creating web service"
docker service create --name nlpwebserver \
	--env MYSQL_ROOT_PASSWORD=new-password \
	--env MYSQL_DATABASE=nlpmt \
	--env MYSQL_USER=NLP_APP_USER \
	--env MYSQL_PASSWORD=yourpassword \
	--replicas 1 \
	--network nlpnet \
    -p 8083:8083 \
    --restart=unless-stopped \
	healthcatalyst/fabric.nlp.docker.web

echo "Sleeping..."
sleep 10s;

# https://askubuntu.com/questions/20414/find-and-replace-text-within-a-file-using-commands
# sed -i 's/original/new/g' file.txt

echo "Updating config"

docker exec nlpwebserver sh /etc/nlp/nlpweb/updateconfig.sh fabricnlpjobs.eastus.cloudapp.azure.com

docker restart fabric.nlp.docker.web

sleep 1s;