#!/bin/sh
set -e
#
# This script is meant for quick & easy install via:
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>'
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s master 10.0.0.5 10.0.0.6 10.0.0.7'
# or:
#   'wget -qO- https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>'
#
#

echo "Starting setup..."
u="$(whoami)"
echo "User name: $u"

# echo "param 1: [" $1 "]"

if [ "$#" -lt 2 ]; then
  echo "Error: Must pass NodeName IP1 IP2(optional) IP3(optional)" >&2
  echo "Usage: curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>" >&2
  exit 1
fi

# no spaces allowed in variable set commands
MyNodeName="$1"
ip1="$2"
ip2="$3"
ip3="$4"
hosts="$ip1"

if [ ! -z "$ip2" ]; then
  hosts="$hosts"",""$ip2"
fi

if [ ! -z "$ip3" ]; then
  hosts="$hosts"",""$ip3"
fi

# http://stackoverflow.com/questions/8529181/which-terminal-command-to-get-just-ip-address-and-nothing-else
myip=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')

externalip=$(curl ipecho.net/plain)

echo "node name: [$MyNodeName]" 
echo "ip1: $ip1"
echo "ip2: $ip2"
echo "ip3: $ip3"
echo "myip: $myip"
echo "hosts: $hosts"

echo "Creating persistent volume for ElasticSearch"
docker volume create --name esdata

echo "Creating update script"

installfolder="/opt/install/"
installscript=$installfolder"updateelasticsearch"

sudo mkdir -p $installfolder

sudo setfacl -m u:$u:rwx $installfolder

echo "#!/bin/sh" > $installscript
echo "docker stop dockerelasticsearch" >> $installscript
echo "docker rm dockerelasticsearch" >> $installscript
echo "docker rmi imranq2/dockerelasticsearch" >> $installscript
echo "docker pull imranq2/dockerelasticsearch" >> $installscript

echo "docker run -d -p 9200:9200 -p 9300:9300 -v esdata:/usr/share/elasticsearch/data --add-host es-master:$ip1 --add-host es-slave1:$ip2 --add-host es-slave2:$ip3 --security-opt seccomp=unconfined -e ES_JAVA_OPTS=\"-Xms2g -Xmx2g\" --name dockerelasticsearch imranq2/dockerelasticsearch -Enetwork.host=_eth0_ -Enetwork.publish_host=$myip -Enode.name=$MyNodeName" -Ediscovery.zen.ping.unicast.hosts=\"$hosts\"  >> /opt/install/updateelasticsearch

echo "Downloading and installing ElasticSearch Docker container"

chmod +x $installscript

cat $installscript

$installscript

echo "Listing docker containers"
docker ps

echo "sleeping for 10 seconds"
sleep 10s

#echo "waiting"
#read -n 1 -p "Click to continue" < /dev/tty

echo "checking from localhost"
curl -X GET http://localhost:9200

# echo "checking from externalip"
# curl -X GET http://$externalip:9200
