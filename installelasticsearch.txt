#!/bin/sh
set -e
#
# This script is meant for quick & easy install via:
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>'
#   'curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s master 10.0.0.5 10.0.0.6 10.0.0.7'
# or:
#   'wget -qO- https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>'
#
#

echo "Starting setup..."
u="$(whoami)"
echo "User name: $u"

# echo "param 1: [" $1 "]"

if [ "$#" -ne 4 ]; then
  echo "Error: Must pass NodeName IP1 IP2 IP3" >&2
  echo "Usage: curl -sSL https://imranq2.github.io/InstallScripts/installelasticsearch.txt | sh -s <nodename> <ip1> <ip2> <ip3>" >&2
  exit 1
fi

# no spaces allowed in variable set commands
MyNodeName="$1"
ip1="$2"
ip2="$3"
ip3="$4"

# http://stackoverflow.com/questions/8529181/which-terminal-command-to-get-just-ip-address-and-nothing-else
myip=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')

externalip=$(curl ipecho.net/plain)

echo "node name: [$MyNodeName]" 
echo "ip1: $ip1"
echo "ip2: $ip2"
echo "ip3: $ip3"
echo "myip: $myip"

echo "Creating persistent volume for ElasticSearch"
docker volume create --name esdata

echo "Creating update script"

sudo mkdir -p /opt/install

sudo setfacl -m u:$u:rwx /opt/install

echo "#!/bin/sh" > /opt/install/updateelasticsearch
echo "docker stop dockerelasticsearch" >> /opt/install/updateelasticsearch
echo "docker rm dockerelasticsearch" >> /opt/install/updateelasticsearch
echo "docker rmi imranq2/dockerelasticsearch" >> /opt/install/updateelasticsearch
echo "docker pull imranq2/dockerelasticsearch" >> /opt/install/updateelasticsearch

echo "docker run -d -p 9200:9200 -p 9300:9300 -v esdata:/usr/share/elasticsearch/data --add-host es-master:$ip1 --add-host es-slave1:$ip2 --add-host es-slave2:$ip3 --security-opt seccomp=unconfined -e ES_JAVA_OPTS=\"-Xms2g -Xmx2g\" --name dockerelasticsearch imranq2/dockerelasticsearch -Enetwork.host=_eth0_ -Enetwork.publish_host=$myip -Enode.name=$MyNodeName"  >> /opt/install/updateelasticsearch

echo "Downloading and installing ElasticSearch Docker container"

sh /opt/install/updateelasticsearch

echo "Listing docker containers"
docker ps

echo "sleeping for 5 seconds"
sleep 5s

echo "checking from localhost"
curl -X GET http://localhost:9200

# echo "checking from externalip"
# curl -X GET http://$externalip:9200
