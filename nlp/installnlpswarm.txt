#!/bin/sh
set -e

echo "Version 1.055"

#
# This script is meant for quick & easy install via:
#   curl -sSL https://healthcatalyst.github.io/InstallScripts/nlp/installnlpswarm.txt | sh -s

# Remember: no spaces allowed in variable set commands in bash

echo "---------------------------------------------------"
echo "This script sets up the Fabric.Realtime cluster on Docker"
echo "----------------------------------------------------"

# if wait-for-it is not installed then install it
if [[ ! -f "/usr/local/bin/wait-for-it" ]]
then
	sudo yum -y install which dos2unix
	curl -sSL -o /tmp/wait-for-it.sh https://healthcatalyst.github.io/InstallScripts/wait-for-it.sh?rand=$RANDOMNUMBER \
		&& dos2unix /tmp/wait-for-it.sh \
		&& chmod +x /tmp/wait-for-it.sh \
		&& sudo cp /tmp/wait-for-it.sh /usr/bin/wait-for-it \
		&& sudo cp /tmp/wait-for-it.sh /usr/local/bin/wait-for-it \
		&& echo "curl -sSL https://healthcatalyst.github.io/InstallScripts/nlp/installnlpswarm.txt | sh -s" | sudo tee /usr/local/bin/updatenlp \
		&& sudo chmod +x /usr/local/bin/updatenlp
fi

myhost="$1"

# docker service rm mysqlserver || echo "mysqlserver is not already present"
# docker service rm solrserver || echo "solrserver is not already present"
# docker service rm jobserver || echo "jobserver is not already present"
# docker service rm nlpwebserver || echo "nlpwebserver is not already present"
# docker network rm nlpnet || echo "nlpnet is not already present"

docker stack rm fabricnlp

echo "existing services"
docker service ls

# calculate a random number to force urls not be cached
# from https://gist.github.com/earthgecko/3089509
RANDOMNUMBER=$(cat /dev/urandom | tr -dc '0-9' | fold -w 256 | head -n 1 | sed -e 's/^0*//' | head --bytes 7)
if [ "$RANDOMNUMBER" == "" ]; then
  RANDOMNUMBER=0
fi

echo "Random Number:$RANDOMNUMBER"

#------ ask for any parameters we need --------------

# disable set -e so the script does not break when there is an error
set +e


docker secret inspect ExternalHostName
if [ $? -ne 0 ]; then
	read -p "Please type in hostname:" ExternalHostName < /dev/tty
	echo $ExternalHostName | docker secret create ExternalHostName  -
fi

docker secret inspect MySQLPassword
if [ $? -ne 0 ]; then
	read -p "Please type in password to use for MySql account (NLP_APP_USER):" -e MySQLPassword < /dev/tty
	echo $MySQLPassword | docker secret create MySQLPassword -
fi

docker secret inspect MySQLRootPassword
if [ $? -ne 0 ]; then
	read -p "Please type in password to use root MySql account:" MySQLRootPassword < /dev/tty
	echo $MySQLRootPassword | docker secret create MySQLRootPassword  -
fi

# docker secret inspect SmtpServer
#if [ $? -ne 0 ]; then
#	read -p "Please type in SMTP Server:" SmtpServer < /dev/tty
#	echo $SmtpServer | docker secret create SmtpServer  -
#fi

set -e


# ------ set environment variables for the docker stack ----------------
export SHARED_DRIVE_LOGS="/var/logs/fluentd/fabricnlp"
sudo mkdir -p "${SHARED_DRIVE_LOGS}"

export SHARED_DRIVE_SOLR=/mnt/hcshared/fabricnlp/solr
sudo mkdir -p "${SHARED_DRIVE_SOLR}"

export SHARED_DRIVE_MYSQL=/mnt/hcshared/fabricnlp/mysql
sudo mkdir -p "${SHARED_DRIVE_MYSQL}"

export smtpserver=""

# ---------- use docker stack deploy to start up all the services --------
stackfilename="nlp-stack.yml"

curl -sSL "https://healthcatalyst.github.io/InstallScripts/nlp/${stackfilename}?rand=$RANDOMNUMBER" | docker stack deploy --compose-file - fabricnlp

echo "logs are stored at: ${SHARED_DRIVE_LOGS}"