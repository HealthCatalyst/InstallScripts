#!/bin/sh
set -e

echo "Version 1.090"

#
# This script is meant for quick & easy install via:
#   curl -sSL https://healthcatalyst.github.io/InstallScripts/realtime/installrealtimeswarm.txt | sh -s

# Remember: no spaces allowed in variable set commands in bash
myhostname="$1"
MySQLUser="mirthuser"

# these are set in the script below
CertPassword=""
RabbitMqMgmtUiPassword=""
MySQLPassword=""
MySQLRootPassword=""

echo "---------------------------------------------------"
echo "This script sets up the Fabric.Realtime cluster on Docker"
echo "----------------------------------------------------"

# if wait-for-it is not installed then install it
if [ ! -f "/usr/local/bin/wait-for-it" ]
then
	sudo yum -y install which dos2unix
	curl -sSL -o /tmp/wait-for-it.sh https://healthcatalyst.github.io/InstallScripts/wait-for-it.sh \
		&& dos2unix /tmp/wait-for-it.sh \
		&& chmod +x /tmp/wait-for-it.sh \
		&& sudo cp /tmp/wait-for-it.sh /usr/local/bin/wait-for-it
fi

# see if we already have a cert store created
hasexistingvolume=""
docker volume inspect --format '{{ .Mountpoint }}' fabriccertificatestore 2> /dev/null && hasexistingvolume="yes" || echo "No existing volume for fabriccertificatestore found"

hasexistingmysqldata=""
docker volume inspect --format '{{ .Mountpoint }}' mysqlstore 2> /dev/null && hasexistingmysqldata="yes" || echo "No existing volume for mysqlstore found"

hasexistingrabbitmqdata=""
docker volume inspect --format '{{ .Mountpoint }}' rabbitmqstore 2> /dev/null && hasexistingrabbitmqdata="yes" || echo "No existing volume for rabbitmqstore found"

deleteOldSSLCertificates=""

# if there is an existing volume then ask if user wants to delete it
if [ ! -z "$hasexistingvolume" ]; then
	while true; do
		read -e -p "Do you wish to delete any existing SSL certificates (this will break anyone using current client certificates)?" yn < /dev/tty
		case $yn in
			[Yy]* ) deleteOldSSLCertificates="yes"; break;;
			[Nn]* ) break;;
			* ) echo "Please answer yes or no.";;
		esac
	done

	if [ ! -z "$deleteOldSSLCertificates" ]; then
		hasexistingvolume=""
	fi
fi

# remove any existing running containers
docker service rm interfaceengine || echo "interfaceengine is not already present"
docker service rm mysqlserver || echo "certificateserver is not already present"
docker service rm rabbitmq || echo "rabbitmq is not already present"
docker service rm certificateserver || echo "certificateserver is not already present"
docker service rm certdownloadserver || echo "certdownloadserver is not already present"

echo "sleeping to let containers be removed"
sleep 3s;

# remove virtual network
docker network rm realtimenet || echo "realtimenet is not already present"

echo "sleeping to let network be removed"
sleep 15s;

docker volume rm rabbitmqcertstore || echo 'volume rabbitmqcertstore does not exist'


# if there is no existing volume then ask for passwords
if [ -z "$hasexistingvolume" ]; then
	if [ -z "$myhostname" ]; then
		read -p "Please type in hostname to use for SSL certificate: " myhostname < /dev/tty
	fi

	read -p "Please type in password to use for client certificate: " CertPassword < /dev/tty
	echo "Password:"$CertPassword
	docker secret rm CertPassword || echo ""
	echo $CertPassword | docker secret create CertPassword -

	read -p "Please type in password to use with admin user for RabbitMq Admin UI:" RabbitMqMgmtUiPassword < /dev/tty
	docker secret rm RabbitMqMgmtUiPassword || echo ""
	echo $RabbitMqMgmtUiPassword | docker secret create RabbitMqMgmtUiPassword -

	read -p "Please type in password to use for MySql account (mirthuser):" MySQLPassword < /dev/tty
	docker secret rm MySQLPassword || echo ""
	echo "Password:"$MySQLPassword
	echo $MySQLPassword | docker secret create MySQLPassword -

	read -p "Please type in password to use root MySql account:" MySQLRootPassword < /dev/tty
	docker secret rm MySQLRootPassword || echo ""
	echo "Password:"$MySQLRootPassword
	echo $MySQLRootPassword | docker secret create MySQLRootPassword  -
fi

# delete the volume if it exists
if [ ! -z "$deleteOldSSLCertificates" ]; then
  	echo "Deleting old SSL certificates"

	docker volume rm fabriccertificatestore || echo 'volume fabriccertificatestore does not exist'

	docker volume rm mysqlstore || echo 'volume mysqlstore does not exist'

	docker volume rm rabbitmqstore || echo 'volume rabbitmqstore does not exist'
fi

# create the volume to store certificates
docker volume create fabriccertificatestore || echo 'volume fabriccertificatestore already exists'

# create the volume for mysql data
docker volume create mysqlstore || echo 'volume mysqlstore already exists'

# create the volume for rabbitmq data
docker volume create rabbitmqstore || echo 'volume rabbitmqstore already exists'

echo "existing services"
docker service ls

echo "Existing secrets"
docker secret ls


echo "creating realtimenet network"
docker network create \
	--driver overlay \
	--subnet=172.28.0.0/16 \
	--ip-range=172.28.5.0/24 \
realtimenet

echo "Using host:"$myhostname

# use constraints to run the webserver on the same node as rabbitmq

# 8081 = HTTP port for downloading certificates

echo "starting mini webserver to allow access to certificate files"
docker service create --name certificateserver \
	--env CERT_HOSTNAME=$myhostname \
	--env CERT_PASSWORD=$CertPassword \
	-p 8081:3000 \
  	--mount src=fabriccertificatestore,dst=/opt/healthcatalyst/ \
	--constraint "node.role == manager" \
	--network realtimenet \
	--detach=false \
healthcatalyst/fabric.certificateserver

echo "waiting for certificateserver to come up"
wait-for-it $myhostname:8081 -t 60 || docker service logs certificateserver
sleep 15s;

echo "creating rabbitmq service"

# 5672 = Non SSL port (not exposed ourside of this swarm)
# 5671 = SSL port
# 15672 = SSL port for Management Web UI

docker service create --name rabbitmq \
	--env CERT_HOSTNAME=$myhostname \
	--env CERT_PASSWORD=$CertPassword \
	--env RABBITMQ_MGMT_UI_PASSWORD=$RabbitMqMgmtUiPassword \
  	--mount src=fabriccertificatestore,dst=/opt/healthcatalyst/ \
  	--mount src=rabbitmqstore,dst=/var/lib/rabbitmq/ \
	--replicas 1 \
	--constraint "node.role == manager" \
	--network realtimenet \
    -p 5671:5671 \
    -p 15672:15672 \
	--detach=false \
healthcatalyst/fabric.realtime.rabbitmq

echo "waiting for rabbitmq to come up"
wait-for-it $myhostname:5671 -t 60 || docker service logs rabbitmq
wait-for-it $myhostname:15672 -t 60 || docker service logs rabbitmq
sleep 15s;

# affinity documentation
# https://docs.docker.com/engine/reference/commandline/service_create/#options
# https://docs.docker.com/v1.10/swarm/scheduler/filter/

#	--env MYSQL_ROOT_PASSWORD_FILE=/run/secrets/MySQLRootPassword \

echo "creating mysql service"
#  from https://hub.docker.com/_/mariadb/
docker service create --name mysqlserver \
	--env MYSQL_ROOT_PASSWORD=$MySQLRootPassword \
	--env MYSQL_DATABASE=mirthdb \
	--env MYSQL_USER=$MySQLUser \
	--env MYSQL_PASSWORD=$MySQLPassword \
  	--mount src=mysqlstore,dst=/var/lib/mysql \
	--replicas 1 \
	--network realtimenet \
    -p 3306:3306 \
	--detach=false \
	healthcatalyst/fabric.realtime.mysql

echo "waiting for mysql to come up"
# wait-for-it $myhostname:3306 -t 60 || docker service logs mysqlserver
sleep 5s;

# 8080 = HTTP port
# 8443 = HTTPS port
# 6661 = Port for receiving HL7 messages

echo "creating mirth service"
docker service create --name interfaceengine \
	--secret MySQLPassword \
	--env MYSQL_PASSWORD=$MySQLPassword \	
	--env MYSQL_USER=$MySQLUser \
	--replicas 1 \
	--network realtimenet \
    -p 8080:8080 \
    -p 8443:8443 \
    -p 6661:6661 \
	--detach=false \
healthcatalyst/fabric.docker.interfaceengine

echo "waiting for interfaceengine to come up"
wait-for-it $myhostname:8080 -t 60 || docker service logs interfaceengine
# wait-for-it $myhostname:8433 -t 60 || docker service logs interfaceengine
wait-for-it $myhostname:6661 -t 60 || docker service logs interfaceengine
sleep 5s;

echo "testing rabbitmq one more time"
wait-for-it $myhostname:5671 -t 60 || docker service logs rabbitmq

echo "if you want, you can download the CA (Certificate Authority) cert from this url"
echo "http://$myhostname:8081/client/fabric_ca_cert.p12"

echo "-------------------------------"
echo "you can download the client certificate from this url:"
echo "http://$myhostname:8081/client/fabricrabbitmquser_client_cert.p12"
echo "-------------------------------"

