#!/bin/sh

echo "Version 1.068"

#
# This script is meant for quick & easy install via:
#   curl -sSL https://healthcatalyst.github.io/InstallScripts/azure/createkubernetescluster.txt | sh -s

# Remember: no spaces allowed in variable set commands in bash

AKS_PERS_RESOURCE_GROUP=
AKS_PERS_LOCATION=
AKS_CLUSTER_NAME=
AKS_PERS_STORAGE_ACCOUNT_NAME=
AKS_PERS_SHARE_NAME=
AKS_SUBSCRIPTION_ID=
AKS_VNET_NAME=
AKS_SUBNET_NAME=
AKS_SSH_KEY=

# AKS_PERS_RESOURCE_GROUP=fabricnlpkubernetes
# AKS_PERS_LOCATION=eastus
# AKS_CLUSTER_NAME=fabricnlpcluster
# AKS_PERS_STORAGE_ACCOUNT_NAME=fabricnlpclusterstorage
# AKS_PERS_SHARE_NAME=fileshare

# AKS_PERS_RESOURCE_GROUP=ImranNLPTest
# AKS_PERS_LOCATION=westus
# AKS_CLUSTER_NAME=cluster1
# AKS_PERS_STORAGE_ACCOUNT_NAME=ImranNLPTeststorage
# AKS_PERS_SHARE_NAME=fileshare

echo "checking if you're already logged in"
loggedInUser=$(az.cmd account show --query "user.name")

if [[ ! -z $loggedInUser ]]
then
    SUBSCRIPTION_NAME=$(az.cmd account show --query "name")
    echo "You are currently logged in as $loggedInUser into subscription $SUBSCRIPTION_NAME"
    DO_RELOGIN=
    read -p "Do you want to continue or logged in again (type ENTER to continue or any key to login again):" DO_RELOGIN < /dev/tty
    if [[ ! -z  $DO_RELOGIN ]]
    then
        az.cmd login
    fi
else
    # login
    az.cmd login
fi

echo getting current subscription id
az.cmd account show
AKS_SUBSCRIPTION_ID=$(az.cmd account show --query "id")
read -p "Using above subscription.  Check and then click enter to continue or ctrl-C to exit"

read -p "Resource Group: (e.g., fabricnlp-rg):" AKS_PERS_RESOURCE_GROUP < /dev/tty
read -p "Location: (e.g., eastus):" AKS_PERS_LOCATION < /dev/tty
read -p "Cluster Name: (e.g., fabricnlpcluster):" AKS_CLUSTER_NAME < /dev/tty
read -p "Storage Account Name: (leave empty for default):" AKS_PERS_STORAGE_ACCOUNT_NAME < /dev/tty
read -p "Storage File share Name: (leave empty for default):" AKS_PERS_SHARE_NAME < /dev/tty

# see if the user wants to use a specific virtual network
read -p "Virtual Network Name: (leave empty for default):" AKS_VNET_NAME < /dev/tty
if [[ -z  "${AKS_PERS_STORAGE_ACCOUNT_NAME}" ]]
then
read -p "Subnet Name: " AKS_SUBNET_NAME < /dev/tty
fi

if [[ -z  "${AKS_PERS_STORAGE_ACCOUNT_NAME}" ]]
then
    AKS_PERS_STORAGE_ACCOUNT_NAME=${AKS_PERS_RESOURCE_GROUP}storage
    echo "Using storage account: ${AKS_PERS_STORAGE_ACCOUNT_NAME}"
fi

if [[ -z  "${AKS_PERS_SHARE_NAME}" ]]
then
    AKS_PERS_SHARE_NAME=fileshare
    echo "Using share name: ${AKS_PERS_SHARE_NAME}"
fi

echo "enable AKS container service"
az.cmd provider show -n Microsoft.ContainerService


echo "checking if resource group already exists"
resourceGroupExists=$(az.cmd group exists --name ${AKS_PERS_RESOURCE_GROUP})
if [[ ! -z $resourceGroupExists ]]
then
    read -p "The resource group ${AKS_PERS_RESOURCE_GROUP} already exists.  Would you like to delete it? (type ENTER to continue or CTRL-C to exit)"

    echo delete existing group: $AKS_PERS_RESOURCE_GROUP

    az.cmd group delete --name $AKS_PERS_RESOURCE_GROUP
fi

echo "Create the Resource Group"
az.cmd group create --name $AKS_PERS_RESOURCE_GROUP --location $AKS_PERS_LOCATION

AKS_SERVICE_PRINCIPAL_NAME=${AKS_PERS_RESOURCE_GROUP}Kubernetes

echo "checking if Service Principal already exists"
AKS_SERVICE_PRINCIPAL_CLIENTID=$(az.cmd ad sp list --display-name ${AKS_SERVICE_PRINCIPAL_NAME} --query "[].appId" -o tsv)

if [[ ! -z "$AKS_SERVICE_PRINCIPAL_CLIENTID" ]]
then
    echo "Service Principal already exists with name: $AKS_SERVICE_PRINCIPAL_NAME"
    exit 1
fi

echo "Creating Service Principal"
AKS_SERVICE_PRINCIPAL_CLIENTSECRET=$(az.cmd ad sp create-for-rbac --role="Contributor" --scopes="/subscriptions/$AKS_SUBSCRIPTION_ID/resourceGroups/$AKS_PERS_RESOURCE_GROUP" --name ${AKS_SERVICE_PRINCIPAL_NAME} --query "password")
# clientID == appID
# client secret == password
AKS_SERVICE_PRINCIPAL_CLIENTID=$(az.cmd ad sp list --display-name ${AKS_SERVICE_PRINCIPAL_NAME} --query "[].appId" -o tsv)

echo $AKS_SERVICE_PRINCIPAL_NAME $AKS_SERVICE_PRINCIPAL_CLIENTID $AKS_SERVICE_PRINCIPAL_CLIENTSECRET

echo "creating SSH key"
ssh-keygen -t rsa -b 2048 -q -N "" -C azureuser@linuxvm -f ~/.ssh/id_rsa

AKS_SSH_KEY=$(cat ~/.ssh/id_rsa.pub)

# create deployment so we can set vnet and subnet
az.cmd group deployment create --template-file "azuredeploy.json" \
    --resource-group $AKS_PERS_RESOURCE_GROUP -n $AKS_CLUSTER_NAME \
    --parameters dnsNamePrefix=kubcluster adminUsername=azureuser sshRSAPublicKey=${AKS_SSH_KEY} servicePrincipalClientId=$AKS_SERVICE_PRINCIPAL_CLIENTID servicePrincipalClientSecret=$AKS_SERVICE_PRINCIPAL_CLIENTSECRET subscriptionId=$AKS_SUBSCRIPTION_ID resourceGroup=${AKS_PERS_RESOURCE_GROUP} vNet=$AKS_VNET_NAME subNet=$AKS_SUBNET_NAME

echo create Azure Container Service cluster AKS
# az.cmd acs create --orchestrator-type kubernetes --resource-group $AKS_PERS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME --generate-ssh-keys --agent-count=3 --agent-vm-size Standard_B2ms

echo sleeping for 10 secs
# sleep 30s;

read -p "Press enter to continue once all the nodes are created"

echo "download kubectl"
mkdir -p c:/kubernetes
rm c:/kubernetes/kubectl.exe
az.cmd acs install-cli --resource-group=$AKS_PERS_RESOURCE_GROUP --name=$AKS_CLUSTER_NAME --install-location c:/kubernetes

echo get credentials for AKS cluster
az.cmd acs kubernetes get-credentials --resource-group=$AKS_PERS_RESOURCE_GROUP --name=$AKS_CLUSTER_NAME

echo check nodes via kubectl
kubectl get nodes

nodeCount=0

while [ $nodeCount -lt 3 ]
do
sleep 10s;
nodeCount=$(wc -l <<< "$(kubectl get nodes -o=name)")
echo nodes: $nodeCount
done



echo Create the storage account
az.cmd storage account create -n $AKS_PERS_STORAGE_ACCOUNT_NAME -g $AKS_PERS_RESOURCE_GROUP -l $AKS_PERS_LOCATION --sku Standard_LRS

# Export the connection string as an environment variable, this is used when creating the Azure file share
AZURE_STORAGE_CONNECTION_STRING=$(az.cmd storage account show-connection-string -n $AKS_PERS_STORAGE_ACCOUNT_NAME -g $AKS_PERS_RESOURCE_GROUP -o tsv)

echo Create the file share
az.cmd storage share create -n $AKS_PERS_SHARE_NAME --connection-string $AZURE_STORAGE_CONNECTION_STRING

echo Get storage account key
STORAGE_KEY=$(az.cmd storage account keys list --resource-group $AKS_PERS_RESOURCE_GROUP --account-name $AKS_PERS_STORAGE_ACCOUNT_NAME --query "[0].value" -o tsv)

echo storagekey: $STORAGE_KEY

echo creating kubernetes secret
kubectl create secret generic azure-secret --from-literal=azurestorageaccountname="${AKS_PERS_STORAGE_ACCOUNT_NAME}" --from-literal=azurestorageaccountkey="${STORAGE_KEY}"

# kubectl apply -f testfileshare-pod.yml

# kubectl describe pod testfileshare-pod

# https://docs.microsoft.com/en-us/azure/aks/kubernetes-dashboard
echo open kubernetes dashboard in browser
az.cmd acs browse --resource-group $AKS_PERS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME &

echo deploy the ingress controller
kubectl apply -f ingress.yml

kubectl get deployments,pods,services,ingress,secrets --namespace=kube-system




