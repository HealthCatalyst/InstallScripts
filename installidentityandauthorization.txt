#!/bin/sh
couchdb_username=$1
couchdb_password=$2

if [ $3 ]; then
	runsetup=$3
fi

if ! [ $runsetup ]; then
	runsetup=true
fi

if [ $4 ]; then
	couchport=$4
fi

if ! [ $couchport ]; then
	couchport=5984
fi

if [ $5 ]; then
	authzversion=$5
fi

if ! [ $authzversion ]; then
	authzversion="latest"
fi

if ! [ $6 ]; then
	identityversion=$6
fi

if ! [ $identityversion ]; then
	identityversion="latest"
fi

#
# This script is meant for quick & easy install via:
#   curl -sSL https://healthcatalyst.github.io/InstallScripts/installidentityandauthorization.txt | sh /dev/stdin [couchdb_username] [couchdb_password]

u="$(whoami)"
echo "Running as: $u"


echo "stopping existing docker containers"
docker stop fabric.identity || echo 'no container to stop'
docker stop fabric.authorization || echo 'no container to stop'
docker stop fabric.couchdb || echo 'no container to stop'
echo "removing docker container"
docker rm fabric.identity || echo 'no container to remove'
docker rm fabric.authorization || echo 'no container to remove'
docker rm fabric.couchdb || echo 'no container to remove'
echo "removing docker volume for couchdb"
docker volume rm couchdb-data || echo 'no volume to remove'
echo "removing docker image"
echo "pulling latest docker image from repo"
docker pull healthcatalyst/fabric.identity:$identityversion
docker pull healthcatalyst/fabric.authorization:$authzversion
docker pull healthcatalyst/fabric.docker.couchdb

echo "starting couchdb."
docker run -d --name fabric.couchdb \
    -e "COUCHDB_USER=$couchdb_username" \
    -e "COUCHDB_PASSWORD=$couchdb_password" \
    -v couchdb-data:/opt/couchdb/data \
    -p 0.0.0.0:$couchport:5984 healthcatalyst/fabric.docker.couchdb

sleep 20 

echo "starting fabric.identity"
docker run -d --name fabric.identity \
    -e "HostingOptions__UseInMemoryStores=false" \
    -e "CouchDbSettings__Server=http://couchdb:5984" \
    -e "CouchDbSettings__Username=$couchdb_username" \
    -e "CouchDbSettings__Password=$couchdb_password" \
    -p 5001:5001 \
    --link fabric.couchdb:couchdb \
    healthcatalyst/fabric.identity:$identityversion

sleep 10
if [ "$runsetup" = true ]; then
	curl -sSL -O https://raw.githubusercontent.com/HealthCatalyst/Fabric.Identity/master/Fabric.Identity.API/scripts/setup-samples.sh
	. ./setup-samples.sh
	rm setup-samples.sh
fi

echo "starting fabric.authorization"
docker run -d --name fabric.authorization \
    -e "CouchDbSettings__Server=http://couchdb:5984" \
    -e "CouchDbSettings__Username=$couchdb_username" \
    -e "CouchDbSettings__Password=$couchdb_password" \
    -e "IdentityServerConfidentialClientSettings__ClientSecret=$authapisecret" \
    -p 0.0.0.0:5004:5004 \
    --link fabric.identity:localhost \
    --link fabric.couchdb:couchdb \
    healthcatalyst/fabric.authorization:$authzversion

sleep 10
if [ "$runsetup" = true ]; then
	curl -sSL https://raw.githubusercontent.com/HealthCatalyst/Fabric.Authorization/master/Fabric.Authorization.API/scripts/setup-samples.sh | sh /dev/stdin $installersecret
fi
