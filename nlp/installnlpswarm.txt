#!/bin/sh
set -e

echo "Version 1.01"

#
# This script is meant for quick & easy install via:
#   'curl -sSL https://healthcatalyst.github.io/InstallScripts/nlp/installnlpswarm.txt | sh -s <mysqlserver> <solrserver> <jobserver>'

# Remember: no spaces allowed in variable set commands in bash

authority=$1
authcert=$2

echo "creating nlpnet network"
docker network create --driver overlay nlpnet

echo "creating mysql service"
docker service create --name mysqlserver \
	--env MYSQL_ROOT_PASSWORD=new-password \
	--env MYSQL_DATABASE=nlpmt \
	--env MYSQL_USER=NLP_APP_USER \
	--env MYSQL_PASSWORD=yourpassword \
	--replicas 1 \
	--constraint "node.labels.worker == 1" \
	--network nlpnet \
    -p 3306:3306 \
	--detach=false \
	healthcatalyst/fabric.nlp.docker.mysql

echo "creating solr service"
docker service create --name solrserver \
	--replicas 1 \
	--network nlpnet \
	--constraint "node.labels.worker == 1" \
    -p 8085:8085 \
	--detach=false \
	healthcatalyst/fabric.nlp.docker.solr

echo "creating jobs service"
docker service create --name jobserver \
	--replicas 1 \
	--network nlpnet \
	--constraint "node.labels.worker == 1" \
    -p 8084:8084 \
	--detach=false \
	healthcatalyst/fabric.nlp.docker.jobs

echo "creating web service"
docker service create --name nlpwebserver \
	--env MYSQL_ROOT_PASSWORD=new-password \
	--env MYSQL_DATABASE=nlpmt \
	--env MYSQL_USER=NLP_APP_USER \
	--env MYSQL_PASSWORD=yourpassword \
	--constraint "node.labels.worker == 1" \
	--replicas 1 \
	--network nlpnet \
    -p 8083:8083 \
	--detach=false \
	healthcatalyst/fabric.nlp.docker.web

