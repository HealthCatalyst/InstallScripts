#!/bin/sh
set -e

echo "Version 1.23"

#
# This script is meant for quick & easy install via:
#   'curl -sSL https://healthcatalyst.github.io/InstallScripts/realtime/installrabbitmq.txt | sh -s <hostname for cert>'

hostname=$1
echo "hostname="$hostname

echo "stopping existing docker container"
docker stop fabric.realtime.rabbitmq || echo 'no container to stop'
echo "removing docker container"
docker rm fabric.realtime.rabbitmq || echo 'no container to remove'
echo "pulling latest docker image"
docker pull healthcatalyst/fabric.realtime.rabbitmq:latest || echo 'local image is up to date'

docker run -p 15672:15672 -p 5671:5671 -p 5672:5672 -p 15671:15671 -p 25672:25672 -d --hostname=$hostname --name fabric.realtime.rabbitmq -t healthcatalyst/fabric.realtime.rabbitmq:latest

echo "sleeping until docker container is up"
until [ "`/usr/bin/docker inspect -f {{.State.Running}} fabric.realtime.rabbitmq`"=="true" ]; do
    sleep 1s;
done;

echo "generating client certificates"
# docker exec fabric.realtime.rabbitmq sh opt/healthcatalyst/scripts/generatecerts.sh $hostname
docker cp fabric.realtime.rabbitmq:/home/client/keycert.p12 ./

echo "Wrote the client certificate to local folder as keycert.p12"

# docker restart fabric.realtime.rabbitmq

