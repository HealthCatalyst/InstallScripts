#!/bin/sh
set -e

echo "Version 1.02"

#
# This script is meant for quick & easy install via:
#   curl -sSL https://healthcatalyst.github.io/InstallScripts/realtime/installrealtimeswarm.txt | sh -s

# Remember: no spaces allowed in variable set commands in bash
myhostname="$1"

if [ -z "$myhostname" ]; then
	echo "Please type in hostname to use for SSL certificate:"
	read -e myhostname < /dev/tty
fi

CertPassword="roboconf"

echo "Using host:"$myhostname

docker service rm interfaceengine || echo "interfaceengine is not already present"
docker service rm rabbitmq || echo "rabbitmq is not already present"
docker network rm realtimenet || echo "realtimenet is not already present"

echo "sleeping to let network be removed"
sleep 3s;

echo "existing services"
docker service ls

echo "creating realtimenet network"
docker network create \
	--driver overlay \
	--subnet=172.28.0.0/16 \
	--ip-range=172.28.5.0/24 \
	realtimenet

echo "creating mirth service"
docker service create --name interfaceengine \
	--replicas 1 \
	--network realtimenet \
    -p 8080:8080 \
    -p 8443:8443 \
    -p 6661:6661 \
	--detach=false \
	healthcatalyst/fabric.docker.interfaceengine

echo "waiting for interfaceengine to come up"
sleep 5s;

echo "creating rabbitmq service"


docker service create --name rabbitmq \
	--env hostname=$myhostname \
	--env CERT_PASSWORD=$CertPassword \
	--replicas 1 \
	--network realtimenet \
    -p 5671:5671 \
    -p 5672:5672 \
	--detach=false \
	healthcatalyst/fabric.realtime.rabbitmq

echo "waiting for rabbitmq to come up"
sleep 5s;

