#!/bin/sh
set -e
#
# This script is meant for quick & easy install via:
#   curl -sSL https://raw.githubusercontent.com/HealthCatalyst/InstallScripts/master/kubernetes/setupmaster.txt | sh
#
#

version="2018.02.15.02"
echo "---- setupmaster version $version ----"

u="$(whoami)"
echo "User name: $u"

sudo kubeadm init --kubernetes-version=v1.9.3 --pod-network-cidr=192.168.0.0/16

sleep 10s
# for logs, sudo journalctl -xeu kubelet

mkdir -p $HOME/.kube
sudo cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# calico
# from https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/kubeadm/
kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/kubeadm/1.7/calico.yaml

# flannel
# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml

# enable master to run containers
# kubectl taint nodes --all node-role.kubernetes.io/master-

kubectl get nodes

kubectl get pods -n kube-system -o wide

pods=$(kubectl get pods -n kube-system -o jsonpath='{.items[*].metadata.name}')
waitingonPod="n"
while [[ ! -z $waitingonPod ]]; do
    waitingonPod=""
    echo "---- waiting until all pods are running ---"

    for pod in $pods; do
        podstatus=$(kubectl get pods $pod -n kube-system -o jsonpath='{.status.phase}')
        echo "$pod: $podstatus"
        if [[ $podstatus != "Running" ]]; then
            waitingonPod=$pod
        fi
    done
    sleep 5
done 

# testing
# kubectl run nginx --image=nginx --port=80

# Register the Microsoft RedHat repository
# sudo yum-config-manager \
#    --add-repo \
#    https://packages.microsoft.com/config/rhel/7/prod.repo

# curl https://packages.microsoft.com/config/rhel/7/prod.repo | sudo tee /etc/yum.repos.d/microsoft.repo

# Install PowerShell
# sudo yum install -y powershell

# Start PowerShell
# pwsh

echo "---- end setupmaster version $version ----"
