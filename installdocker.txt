#!/bin/sh
set -e
#
# This script is meant for quick & easy install via:
#   'curl -sSL https://healthcatalyst.github.io/InstallScripts/installdocker.txt | sh'
# or:
#   'wget -qO- https://healthcatalyst.github.io/InstallScripts/installdocker.txt | sh'
#
#

echo "Version 1.21"

echo "Current OS"
echo "$(cat /etc/*-release)"

echo "$(free -g)"

u="$(whoami)"
echo "User name: $u"

# shell syntax: http://linuxcommand.org/wss0090.php
# echo "installing sudo if it doesn't exist"
# yum install sudo -y

echo "updating yum package manager"
sudo yum update -y

sudo yum install wget -y

echo "installing jq"
wget http://stedolan.github.io/jq/download/linux64/jq
sudo chmod +x ./jq
sudo cp jq /usr/bin

sudo sysctl -w vm.max_map_count=262144
# set it for future restarts
echo "vm.max_map_count = 262144" | sudo tee -a /etc/sysctl.conf

echo "downloading and installing docker"
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

# set the stable repo
sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

# update yum package index
sudo yum makecache fast

sudo yum -y install docker-ce

# curl -fsSL https://get.docker.com/ | sh

if [ $u != "root" ]; then
    echo "giving permission to $u"
    sudo usermod -aG docker $u
    echo "Logout and Login and run: curl -sSL https://healthcatalyst.github.io/InstallScripts/setupdocker.txt | sh"
    echo 0
fi

echo "Setting up docker"
curl -sSL https://healthcatalyst.github.io/InstallScripts/setupdocker.txt | sh
